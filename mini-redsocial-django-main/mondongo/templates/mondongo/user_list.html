{% extends 'mondongo/base.html' %} 
{% block title %}Usuarios - Mondongo{% endblock %} 
{% block header %}Gestionar Usuarios{% endblock %} 
{% block content %}

<div class="card">
  <div
    style="
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    "
  >
    <form
      method="get"
      style="display: flex; gap: 10px; align-items: center; width: 100%"
    >
      <input
        type="text"
        name="q"
        placeholder="Buscar por usuario, biografía..."
        value="{{ request.GET.q|default:'' }}"
        style="
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          flex: 1;
        "
      />
      <select
        name="status"
        style="padding: 8px; border: 1px solid #ddd; border-radius: 4px"
        onchange="this.form.submit()"
      >
        <option value="">Todos los estados</option>
        <option
          value="active"
          {%
          if
          request.GET.status=""
          ="active"
          %}selected{%
          endif
          %}
        >
          Activo
        </option>
        <option
          value="inactive"
          {%
          if
          request.GET.status=""
          ="inactive"
          %}selected{%
          endif
          %}
        >
          Inactivo
        </option>
      </select>
      <button type="submit" class="btn-action btn-success">Filtrar</button>
    </form>
  </div>

  <table>
    <thead>
      <tr>
        <th>Usuario</th>
        <th>Email</th>
        <th>Biografía</th>
        <th>Unido el</th>
        <th>Estado</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      {% for profile in profiles %}
      <tr>
        <td>
          <div style="display: flex; align-items: center; gap: 10px">
            {% if profile.avatar %}
            <img
              src="{{ profile.avatar.url }}"
              style="
                width: 30px;
                height: 30px;
                border-radius: 50%;
                object-fit: cover;
              "
            />
            {% else %}
            <div
              style="
                width: 30px;
                height: 30px;
                border-radius: 50%;
                background: #ccc;
              "
            ></div>
            {% endif %}
            <strong>{{ profile.user.username }}</strong>
          </div>
        </td>
        <td>{{ profile.user.email }}</td>
        <td>{{ profile.bio|truncatechars:30 }}</td>
        <td>{{ profile.user.date_joined|date:"d M Y" }}</td>
        <td>
          {% if profile.user.is_active %}
          <span class="status-badge active">Activo</span>
          {% else %}
          <span class="status-badge inactive">Inactivo</span>
          {% endif %}
        </td>
        <td>
          <form
            action="{% url 'mondongo_user_toggle' profile.user.pk %}"
            method="post"
            style="display: inline"
          >
            {% csrf_token %} {% if profile.user.is_active %}
            <button
              type="submit"
              class="btn-action btn-danger"
              onclick="
                return confirm('¿Estás seguro de desactivar a este usuario?');
              "
            >
              Desactivar
            </button>
            {% else %}
            <button type="submit" class="btn-action btn-success">
              Activar
            </button>
            {% endif %}
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" style="text-align: center; padding: 20px">
          No hay usuarios registrados.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if is_paginated %}
  <div class="pagination">
    {% if page_obj.has_previous %}
    <a
      href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
      class="page-link"
      >← Anterior</a
    >
    {% endif %}

    <span style="padding: 8px 16px"
      >Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span
    >

    {% if page_obj.has_next %}
    <a
      href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
      class="page-link"
      >Siguiente →</a
    >
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
