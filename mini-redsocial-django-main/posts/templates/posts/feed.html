{% extends 'base.html' %} 
{% block content %}
<div class="header">Inicio</div>

{% for post in posts %}
<div
  style="
    padding: 15px;
    border-bottom: 1px solid #eff3f4;
    display: flex;
    gap: 10px;
    cursor: pointer;
  "
>
  <a
    href="{% url 'profile_detail' post.author.pk %}"
    style="
      width: 50px;
      min-width: 50px;
      height: 50px;
      background-color: #ccc;
      border-radius: 50%;
      overflow: hidden;
      display: block;
      text-decoration: none;
    "
  >
    {% if post.author.avatar %}
    <img
      src="{{ post.author.avatar.url }}"
      style="width: 100%; height: 100%; object-fit: cover"
    />
    {% endif %}
  </a>
  <div style="flex-grow: 1">
    <div style="margin-bottom: 5px">
      <a href="{% url 'profile_detail' post.author.pk %}" style="font-weight: bold; text-decoration: none; color: inherit">{{ post.author.user.username }}</a>
      <span style="color: #536471"
        >@{{ post.author.user.username }} ¬∑ {{ post.created_at|date:"d M" }}</span
      >
    </div>
    <div style="margin-bottom: 15px; font-size: 15px; line-height: 20px">
      {{ post.content }}
    </div>
    {% if post.image %}
    <div
      style="
        margin-bottom: 10px;
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid #eff3f4;
      "
    >
      <img
        src="{{ post.image.url }}"
        style="width: 100%; height: auto; display: block"
      />
    </div>
    {% endif %}

    <div style="display: flex; gap: 20px; color: #536471; align-items: center">
      <a
        href="{% url 'post_detail' post.pk %}"
        style="
          display: flex;
          align-items: center;
          gap: 5px;
          text-decoration: none;
          color: inherit;
        "
      >
        <span>üí¨</span>
        <span>{{ post.comments.count }}</span>
      </a>

      {% if user.is_authenticated %}
      <button
        class="like-button {% if post.user_liked %}liked{% endif %}"
        data-post-id="{{ post.pk }}"
        data-liked="{% if post.user_liked %}true{% else %}false{% endif %}"
        style="
          display: flex;
          align-items: center;
          gap: 5px;
          background: none;
          border: none;
          cursor: pointer;
          padding: 5px 10px;
          border-radius: 20px;
          transition: background-color 0.2s;
        "
        onmouseover="this.style.backgroundColor = '#f7e0e5'"
        onmouseout="this.style.backgroundColor = 'transparent'"
      >
        <span class="like-icon"
          >{% if post.user_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span
        >
        <span class="like-count">{{ post.likes_count }}</span>
      </button>
      {% else %}
      <div style="display: flex; align-items: center; gap: 5px">
        <span>ü§ç</span>
        <span>{{ post.likes_count }}</span>
      </div>
      {% endif %} {% if user.is_authenticated and user.profile == post.author %}
      <div style="display: flex; gap: 15px; margin-left: auto">
        <a
          href="{% url 'post_update' post.pk %}"
          style="text-decoration: none; font-size: 14px; color: #1da1f2"
          >Editar</a
        >
        <a
          href="{% url 'post_delete' post.pk %}"
          style="text-decoration: none; font-size: 14px; color: #f4212e"
          >Eliminar</a
        >
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% empty %}
<div style="padding: 20px; text-align: center; color: #536471">
  No hay publicaciones disponibles.
</div>
{% endfor %}

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener("DOMContentLoaded", function () {
    const likeButtons = document.querySelectorAll(".like-button");

    likeButtons.forEach((button) => {
      button.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();

        const postId = this.dataset.postId;
        const likeIcon = this.querySelector(".like-icon");
        const likeCount = this.querySelector(".like-count");
        const isLiked = this.dataset.liked === "true";

        fetch(`/posts/post/${postId}/like/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
          },
          credentials: "same-origin",
        })
          .then((response) => response.json())
          .then((data) => {
            likeCount.textContent = data.likes_count;

            if (data.liked) {
              likeIcon.textContent = "‚ù§Ô∏è";
              this.classList.add("liked");
              this.dataset.liked = "true";
            } else {
              likeIcon.textContent = "ü§ç";
              this.classList.remove("liked");
              this.dataset.liked = "false";
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      });
    });
  });
</script>

{% endblock %}
